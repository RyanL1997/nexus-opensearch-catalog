## 10/30/2024

### Deduplication issue found for manual refresh

- It seems only existing on manual refresh index since there is no checkpoint to record the dedup key.
- There was a PR in `opensearch-spark` related to this: [Exactly-once guarantee for covering index and MV incremental refresh #143
](https://github.com/opensearch-project/opensearch-spark/pull/143)
- So no actionable items for now since this is a known behavior

### CloudTrail

- Add 3 fields for the filter panel: "Event Category", "Account ID", and "Services". Update the latest dashboard ndjson: `amazon-cloudtail-log.ndjson`

### VPC

- For VPC MV, add 2 field `protocol AS aws.vpc.protocol` and `dstPort AS aws.vpc.dstport`
- For testing the query correctness, create a new MV (manual refresh):

```sql
CREATE MATERIALIZED VIEW aws_vpc_mv_reinvent
AS
SELECT
  TUMBLE(`@timestamp`, '5 Minute').start AS `start_time`,
  action AS `aws.vpc.action`,
  srcAddr AS `aws.vpc.srcaddr`,
  dstAddr AS `aws.vpc.dstaddr`,
  protocol AS `aws.vpc.protocol`,
  dstPort AS `aws.vpc.dstport`,
  COUNT(*) AS `aws.vpc.total_count`,
  SUM(bytes) AS `aws.vpc.total_bytes`,
  SUM(packets) AS `aws.vpc.total_packets`
FROM (
  SELECT
    action,
    srcAddr,
    dstAddr,
    bytes,
    packets,
    protocol,
    dstPort,
    CAST(FROM_UNIXTIME(start) AS TIMESTAMP) AS `@timestamp`
  FROM
    aws_vpc_20k_oct7
)
GROUP BY
  TUMBLE(`@timestamp`, '5 Minute'),
  action,
  srcAddr,
  dstAddr,
  protocol,
  dstPort
```

- Refresh `REFRESH MATERIALIZED VIEW aws_vpc_mv_reinvent`
- Create a dashboard with 2 additional fields "Protocol" and "Destination Port", update `amazon_vpc_log.ndjson`
